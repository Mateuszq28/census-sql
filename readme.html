<h1>SQL Databse and it's querries.</h1>

<h2>SQLite</h2>

create database

```shell
sqlite3 census.db
```

list tables

```shell
.tables
```

table schema

```shell
.schema tablename
```

sqlite help

```shell
.help
```


<!-- postgresql database -->
<!-- problems with utf-8 -->

<!-- 
<h2>Created Tables</h2>

SET client_encoding = 'UTF8';

<p align="center">
<img src="img_readme/tables.png" alt="Created tables"><br/>
<i>Created tables</i>
</p>

<p align="center">
<img src="img_readme/table_people_info.png" alt="Definition of people table"><br/>
<i>Definition of people table</i>
</p>

<p align="center">
<img src="img_readme/table_work_company_info.png" alt="Definition of work_company table"><br/>
<i>Definition of work_company table</i>
</p>

<p align="center">
<img src="img_readme/table_employment_info.png" alt="Definition of employment table"><br/>
<i>Definition of employment table</i>
</p>
-->


<h2>Generating Data</h2>

<p align="center">
<img src="diagram_erd.png" alt="Diagram ERD"><br/>
<i>Created tables</i>
</p>

<ul>
    <li><i>my_create.sql</i> - definition of the tables</li>
    <li>data</li>
    <ul>
        <li><i>add_people.sql</i> - add data to people table</li>
        <li><i>add_work_company.sql</i> - add data to work_company table</li>
        <li><i>add_employment.sql</i> - add data to employment table</li>
    </ul>
</ul>
<p>Chat GPT an Perplexity were used to generate data to feed the database.</p>

Find duplcated PESELs - works

```shell
grep -oE '\b[0-9]{11}\b' add_people.sql | sort | uniq -d
```

Find duplcated PESELs - doesn't work

```shell
# regex
\b(\d{11})\b(?=.*\b\1\b)

grep -oE '\b[0-9]{11}\b' add_people.sql | sort | uniq -d | grep -Ff - add_people.sql

# didn't try
grep -oE '\b[0-9]{11}\b' add_people.sql | awk '{count[$0]++} END {for (num in count) if (count[num] > 1) print num}'
```

substitute part of a string<br/>
in this case:<br/>
change every 5-zeros string like "0000" into ranfom 5-digit number

```shell
# didn't try
while grep -q "00000" file.txt; do
    sed -i "0,/00000/s//$(shuf -i 10000-99999 -n 1)/" file.txt
done

# works
perl -i -pe 's/00000/sprintf("%05d", int(rand(100000)))/ge' file.txt
```


<h2>Table Indexing</h2>

```sql
CREATE INDEX idx_first_name ON people (first_name);
CREATE INDEX idx_last_name ON people (last_name);
CREATE INDEX idx_pesel ON people (pesel);

CREATE INDEX idx_oneGenerationFamily_manAsRoot
ON people (person_id, wife_id);
CREATE INDEX idx_oneGenerationFamily_womanAsRoot
ON people (person_id, husband_id);

CREATE INDEX
idx_oneGenerationFamily_withParents_manAsRoot
ON people (person_id, wife_id, father_id);
CREATE INDEX
idx_oneGenerationFamily_withParents_womanAsRoot
ON people (person_id, husband_id, mother_id);
```sql

Deleting Indexes Example<br/>

```sql
ALTER TABLE people DROP INDEX idx_first_name;
```

<h1>Querries</h1>

<h2>Task A</h2>

<p>Find the name and surname of the person with the most female grandchildren.</p>

One command

```sql
SELECT
    p1.first_name, 
    p1.last_name,
    COUNT(p3.person_id) AS female_grandchildren_count
FROM 
    people p1
JOIN 
    people p2 ON (p2.mother_id = p1.person_id OR p2.father_id = p1.person_id)
JOIN 
    people p3 ON (p3.mother_id = p2.person_id OR p3.father_id = p2.person_id)
WHERE 
    p3.sex = 'k'
GROUP BY 
    p1.person_id
ORDER BY 
    female_grandchildren_count DESC
LIMIT 1;
```

<h3>View pipeline</h3>

```sql
CREATE VIEW persons_female_grandchildren_count AS
    SELECT
        p1.person_id,
        p1.first_name, 
        p1.last_name,
        COUNT(p3.person_id) AS female_grandchildren_count
    FROM 
        people p1
    JOIN 
        people p2 ON (p2.mother_id = p1.person_id OR p2.father_id = p1.person_id)
    JOIN 
        people p3 ON (p3.mother_id = p2.person_id OR p3.father_id = p2.person_id)
    WHERE 
        p3.sex = 'k'
    GROUP BY 
        p1.person_id
;
SELECT * FROM persons_female_grandchildren_count;


CREATE VIEW all_persons_have_max_granddoughter_count AS
SELECT * FROM persons_female_grandchildren_count
WHERE 
    female_grandchildren_count =
        (SELECT MAX(female_grandchildren_count) FROM persons_female_grandchildren_count)
;
SELECT * FROM all_persons_have_max_granddoughter_count;


CREATE VIEW one_person_have_max_granddoughter_count AS
SELECT * FROM all_persons_have_max_granddoughter_count
ORDER BY person_id ASC
LIMIT 1;
SELECT * FROM one_person_have_max_granddoughter_count;
```


<h2>Task B</h2>




    












